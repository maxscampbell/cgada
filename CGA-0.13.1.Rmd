---
title: "Cash Grab Arena -- Playtest Data Analysis"
author: "Version 0.13.1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

# Load in relevant packages
library(ggplot2)
library(glue)
library(purrr)
library(tidyverse)
library(ggforce)

#Write functions to append the data more efficiently.
read_in_data <- function(fileName, playtestDate = "99/99/9999", playtestVersion = "0.0.*", hasHeaders = FALSE) {
  out <- read.csv(fileName, hasHeaders)
  colnames(out) <- c("ID", "Class", "Trinket", "Map", "Game_ID", "Kills", "Coins", "Is_Complete")
  out <- out |>
    mutate(Date = playtestDate,
           Version = playtestVersion)
  return(out)
}

merge_playtests <- function(dataframes) {
  out <- dataframes[[1]]
  
  for (i in 2:length(dataframes)) {
    out <- rbind(out, dataframes[[i]])
  }
  
  return(out)
}

generate_seqID <- function(x) {
  
  x |>
    mutate(ID = ID + 1) |>
    group_by(Game_ID) |>
    mutate(seqID = 1:n()) |>
    ungroup()
  
}
```

```{r echo=FALSE}
# Read in data
setwd("data")
test1 <- read_in_data("test_data.csv", "01/01/2025", "0.13.1", TRUE)
test2 <- read_in_data("test_data2.csv", "02/02/2025", "0.13.1", TRUE)


#Merge obs. into one set of data
dflist <- list(test1, test2)
cgada <- merge_playtests(dflist)
cgada <- generate_seqID(cgada) |>
  filter(Is_Complete == TRUE)
```

## Class Data

```{r echo=FALSE}
suppressMessages(
  cgada |>
  group_by(Class, Date) |>
  summarise(n=n()) |>
  ungroup() |> group_by(Class) |>
  summarise(sd = sd(n),
            sum = sum(n)) |>
  ggplot(aes(x = Class, y = sum)) +
  geom_bar(stat = "identity", color = "black", fill = "green") +
  theme(legend.position = "none") +
  xlab("Class") + ylab("Number of Lives Played") +
  labs(title = "Class Popularity (% of Total Lives Played)",
       caption = "Red line indicates expected popularity assuming classes are to be equally used.
                  Error bars indicate values which we could likely observe if we repeated a sample of the same number of playtests.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_errorbar(aes(ymin = sum - sd,
                ymax = sum + sd),
                width = 0.5) +
  geom_hline(yintercept = nrow(cgada) / nrow(distinct(cgada, Class)), color = "red")
)

```

```{r echo=FALSE}
suppressMessages(
  cgada |>
  group_by(Class) |>
  summarise(Entry = n(),
         KPE = sum(Kills) / sum(Entry),
         sd = sd(Kills),
         se = sd / sqrt(Entry)) |>
  ggplot(aes(x = Class, y = KPE)) +
  geom_bar(stat = "identity", color = "black", fill = "slateblue") +
  theme(legend.position = "none") +
  xlab("Class") + ylab("Kills") +
  labs(title = "Class Kills per Entry",
       caption = "Red line indicates the average Kills per Entry across all classes.
                  Error bars indicate values which we could likely observe on repeated playtests, accounting for sample size.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_errorbar(aes(ymin = KPE - se,
                ymax = KPE + se),
                width = 0.5) +
  geom_hline(yintercept = sum(cgada$Kills) / nrow(cgada), color = "red")
)
```

```{r echo=FALSE}
suppressMessages(
  cgada |>
  group_by(Class) |>
  summarise(Entry = n(),
         CPE = sum(Coins) / sum(Entry),
         sd = sd(Coins),
         se = sd / sqrt(Entry)) |>
  ggplot(aes(x = Class, y = CPE)) +
  geom_bar(stat = "identity", color = "black", fill = "gold") +
  theme(legend.position = "none") +
  xlab("Class") + ylab("Coins") +
  labs(title = "Class Coins per Entry",
       caption = "Red line indicates the average Coins per Entry across all classes.
                  Error bars indicate values which we could likely observe on repeated playtests, accounting for sample size.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_errorbar(aes(ymin = CPE - se,
                ymax = CPE + se),
                width = 0.5) +
  geom_hline(yintercept = sum(cgada$Coins) / nrow(cgada), color = "red")
)
```

```{r echo=FALSE}
suppressMessages(
  cgada |>
  group_by(Class) |>
  summarise(Entry = n(),
         KPE = sum(Kills) / sum(Entry),
         CPE = sum(Coins) / sum(Entry)) |>
  mutate(KPE.scaled = (KPE - (0.8 * min(KPE))) / ((1.2 * max(KPE)) - (0.8 * min(KPE))),
         CPE.scaled = (CPE - (0.8 * min(CPE))) / ((1.2 * max(CPE)) - (0.8 * min(CPE))),
         Rel.Eff = KPE.scaled - CPE.scaled) |>
  ggplot(aes(x = Class, y = Rel.Eff)) +
  geom_bar(stat = "identity", color = "black", fill = "red") +
  theme(legend.position = "none") +
  xlab("Class") + ylab("% Difference") +
  labs(title = "Relative Efficiency",
       caption = "Positive values indicate more efficient kill generation per life.
          Negative values indicate more efficient coin earnings per life.
          Larger magnitudes suggest more extreme specializations.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_hline(yintercept = 0, color = "black")
)
```

## Trinket Data

```{r echo=FALSE}

suppressMessages(
  cgada |>
  group_by(Trinket, Date) |>
  summarise(n=n()) |>
  ungroup() |> group_by(Trinket) |>
  summarise(sd = sd(n),
            sum = sum(n)) |>
  ggplot(aes(x = Trinket, y = sum)) +
  geom_bar(stat = "identity", color = "black", fill = "orange") +
  theme(legend.position = "none") +
  xlab("Trinket") + ylab("Number of Lives Played") +
  labs(title = "Trinket Popularity",
       caption = "Red line indicates expected popularity assuming classes are to be equally used.
                  Error bars indicate values which we could likely observe if we repeated a sample of the same number of playtests.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_errorbar(aes(ymin = sum - sd,
                ymax = sum + sd),
                width = 0.5) +
  geom_hline(yintercept = nrow(cgada) / nrow(distinct(cgada, Trinket)), color = "red")
)
```

```{r echo=FALSE}
suppressMessages(
  cgada |>
  group_by(Trinket) |>
  summarise(Entry = n(),
         KPE = sum(Kills) / sum(Entry),
         sd = sd(Kills),
         se = sd / sqrt(Entry)) |>
  ggplot(aes(x = Trinket, y = KPE)) +
  geom_bar(stat = "identity", color = "black", fill = "royalblue") +
  theme(legend.position = "none") +
  xlab("Trinket") + ylab("Kills") +
  labs(title = "Trinket Kills per Entry",
       caption = "Red line indicates the average Kills per Entry across all classes.
                  Error bars indicate values which we could likely observe on repeated playtests, accounting for sample size.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_errorbar(aes(ymin = KPE - se,
                ymax = KPE + se),
                width = 0.5) +
  geom_hline(yintercept = sum(cgada$Kills) / nrow(cgada), color = "red")
)
```
```{r echo=FALSE}
suppressMessages(
  cgada |>
  group_by(Trinket) |>
  summarise(Entry = n(),
         CPE = sum(Coins) / sum(Entry),
         sd = sd(Coins),
         se = sd / sqrt(Entry)) |>
  ggplot(aes(x = Trinket, y = CPE)) +
  geom_bar(stat = "identity", color = "black", fill = "gold3") +
  theme(legend.position = "none") +
  xlab("Trinket") + ylab("Coins") +
  labs(title = "Trinket Coins per Entry",
       caption = "Red line indicates the average Coins per Entry across all classes.
                  Error bars indicate values which we could likely observe on repeated playtests, accounting for sample size.") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_errorbar(aes(ymin = CPE - se,
                ymax = CPE + se),
                width = 0.5) +
  geom_hline(yintercept = sum(cgada$Coins) / nrow(cgada), color = "red")
)
```

## Map Data [WIP]

## Within-Game Data [WIP]

### Coins Over Time

```{r echo = FALSE}

  stddevs <- cgada |>
    group_by(seqID) |>
    summarise(mean = mean(Coins),
      sd = sd(Coins))

  cgada |>
  group_by(Game_ID) |>
  ggplot(aes(x = seqID, y = Coins, color = Map)) +
  geom_point() +
  geom_line() +
  stat_summary(aes(group = 1), geom = "line", fun.y = mean, size = 1.5, color = "black") +
  stat_summary(geom = "ribbon", fun.data = 'mean_sdl', mult = 1, color = "gray", alpha = 0.05) +
  labs(title = "Coins Over Time (All Maps)",
       caption = "Bold line is the average across all games.
       Surrounding ribbon represents bounds for values to remain within one standard deviation of the average.") + xlab("Sequential Entry ID")

```

The purpose of this plot is two-fold:

1. The design of Cash Grab is such that that every time a player steps on a plate, 2 more coins enter the "economy" so to speak. As such, the mean number of coins earned per life should generally go up as the game progresses as players approach the coin goal. Below is the same plot, but with only the games that occurred on Scald, as players can effectively remove coins from the game if they die by burning in lava.

2. It's fairly certain that the variance in kills should remain constant over time, as the general parameters of combat in cash grab do not change on a per-life basis. However, the coins that each player holds does change significantly, so it is far less certain how the coins per life will vary. By plotting this, we can get a general understanding of how the passage of time within each game effects the way players earn coins. Some characteristics to look for: lines on the plot branching out to higher and lower extremes as the sequential entry ID goes up (fanning or increasing variance over time), lines on the plot converging towards the average (funneling or decreasing variance over time), or a generally constant block that follows the same patterns that the average does (constant variance over time).

```{r echo = FALSE}
cgada |>
  filter(Map == "Scald") |>
  group_by(Game_ID) |>
  ggplot(aes(x = seqID, y = Coins)) +
  geom_point(color = "purple1") +
  geom_line(color = "purple1") +
  stat_summary(aes(group = 1), geom = "line", fun.y = mean, size = 1.5, color = "black") +
  stat_summary(geom = "ribbon", fun.data = 'mean_sdl', mult = 1, color = "gray", alpha = 0.05) +
  labs(title = "Coins Over Time (Scald)",
       caption = "Bold line is the average across all games.
       Surrounding ribbon represents bounds for values to remain within one standard deviation of the average.") +
  scale_color_manual(labels = c("Alchemist", "Artillery", "Battlesmith", "Champion", "Chronomancer", 
                  "Cloudbreaker", "Dancer", "Evincer", "Frost Knight", "Griefer", 
                  "Hexblade", "Ranger", "Skirmisher", "Spectre", "Stargazer", 
                  "Titan", "Vampire"), values = seq(1:17))
```

## Some Fun Tidbits

### Top Class-and-Trinket Combos by Lives Played

```{r echo=FALSE}
suppressMessages(
print(
cgada |>
  group_by(Class, Trinket) |>
  summarise(LivesPlayed = n()) |>
  arrange(desc(LivesPlayed)),
n = 20)
)
```

### Most Coins Generated on an Entry

```{r echo=FALSE}
cgada |>
  arrange(desc(Coins)) |>
  select(Class, Trinket, Map, Coins) |>
  slice_head(n = 10)
```

### Most Kills on an Entry

```{r echo=FALSE}
cgada |>
  arrange(desc(Kills)) |>
  select(Class, Trinket, Map, Kills) |>
  slice_head(n = 10)
```

[Click here to return to the main page.](https://maxscampbell.github.io/cgada/)